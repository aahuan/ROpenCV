set -x
set -e

mkdir inst/tmp
mkdir inst/opencv/

cd inst/tmp/

Rscript -e 'download.file("https://github.com/Itseez/opencv/archive/3.1.0.tar.gz", "opencv_3.1.0.tar.gz")'
Rscript -e 'download.file("https://github.com/Itseez/opencv_contrib/archive/3.1.0.tar.gz", "opencv_contrib_3.1.0.tar.gz")'

Rscript -e 'untar("opencv_3.1.0.tar.gz")'
Rscript -e 'untar("opencv_contrib_3.1.0.tar.gz")'

cd opencv-3.1.0

echo "" >> modules/python/common.cmake
echo "find_package(HDF5)" >> modules/python/common.cmake
echo "include_directories(${HDF5_INCLUDE_DIRS})" >> modules/python/common.cmake

mkdir build
cd build

cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=../../../opencv/ -D OPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-3.1.0/modules/ ../
make -j4
make install

cd ../../../

rm -rf tmp
